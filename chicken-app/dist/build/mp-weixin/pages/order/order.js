"use strict";const e=require("../../common/vendor.js"),a=require("../../api/shop.js"),l=require("../../api/category.js"),o=require("../../api/dish.js"),s=require("../../api/setmeal.js"),t=require("../../api/cart.js");require("../../utils/http.js"),require("../../stores/modules/user.js"),Math||i();const i=()=>"./components/Navbar.js",n=e.defineComponent({__name:"order",setup(i){const n=e.ref(!0),u=e.ref([]),r=e.ref(0);e.ref(0);const d=e.ref([]);e.ref([]);const v=e.ref(!1),c=e.ref([]),g=e.ref(0),h=e.ref(0),m=e.ref(!1),f=e.ref(),I=e.ref([]),b=e.ref([]),p=async()=>{const e=await l.getCategoryAPI();console.log(e),u.value=e.data,console.log("categoryList",u.value)},w=async e=>{let a;r.value=e,console.log("index",e),console.log("getList by this category",u.value[e]),a=1===u.value[e].type?await o.getDishListAPI(u.value[e].id):await s.getSetmealListAPI(u.value[e].id),console.log(a),d.value=a.data},C=async()=>{const e=await t.getCartAPI();console.log("初始化购物车列表",e),c.value=e.data,g.value=c.value.reduce(((e,a)=>e+a.number),0),h.value=c.value.reduce(((e,a)=>e+a.amount*a.number),0),console.log("CartAllNumber",g.value),console.log("CartAllPrice",h.value),0===c.value.length&&(v.value=!1)},y=e=>{var a,l;return console.log("getCopies",e),u.value[r.value].sort<20?(null==(a=c.value.find((a=>a.dishId===e.id)))?void 0:a.number)||0:(null==(l=c.value.find((a=>a.setmealId===e.id)))?void 0:l.number)||0},A=async(e,a)=>{if(console.log("点击了dialog的 “+” 添加菜品数量按钮",e,a),console.log(u.value[r.value].sort<20),"购物车"==a){console.log("addCart",e);const a={dishId:e.dishId,setmealId:e.setmealId,dishFlavor:e.dishFlavor};await t.addToCartAPI(a)}else if(console.log("普通页面下的dish，点击能直接添加(而不弹出dialog)的菜品说明无口味",e),u.value[r.value].sort<20){const a={dishId:e.id};await t.addToCartAPI(a)}else{const a={setmealId:e.id};await t.addToCartAPI(a)}await C()},j=async(e,a)=>{if(console.log("点击了减少菜品数量按钮subDishAction--------------------",e,a),"购物车"==a){console.log("subCart",e);const a={dishId:e.dishId,setmealId:e.setmealId,dishFlavor:e.dishFlavor};await t.subCartAPI(a)}else if(console.log("普通页面下的dish，不是dialog中的菜品说明无口味",e),u.value[r.value].sort<20){const a={dishId:e.id};await t.subCartAPI(a)}else{const a={setmealId:e.id};await t.subCartAPI(a)}await C()},P=()=>{e.index.switchTab({url:"/pages/index/index"})};return e.onLoad((async()=>{const e=await a.getStatusAPI();console.log("店铺状态---------",e),n.value=1===e.data,await p(),await w(0),await C()})),e.onShow((async()=>{await p(),await C()})),(a,l)=>e.e({a:e.f(u.value,((a,l,o)=>({a:e.t(a.name),b:a.id,c:l===r.value?1:"",d:e.o((e=>w(l)),a.id)}))),b:e.f(d.value,((a,l,o)=>e.e({a:a.pic,b:e.t(a.name),c:e.t(a.detail),d:e.t(a.price),e:"flavors"in a&&a.flavors.length>0},"flavors"in a&&a.flavors.length>0?{f:e.o((e=>(async e=>{console.log("点击了选择规格chooseNorm，得到了该菜品的所有口味数据",e.flavors),I.value=e.flavors;const a=Object.assign({},e);delete a.flavors,f.value=a,e.flavors.map((e=>({...e,list:JSON.parse(e.list)}))).forEach((e=>{e.list&&e.list.length>0&&b.value.push(e.list[0])})),m.value=!0})(a)),a.id)}:e.e({g:y(a)>0},y(a)>0?{h:e.o((e=>j(a,"普通")),a.id)}:{},{i:y(a)>0},y(a)>0?{j:e.t(y(a))}:{},{k:e.o((e=>A(a,"普通")),a.id)}),{l:a.id,m:`/pages/detail/detail?${u.value[r.value].sort<20?"dishId":"setmealId"}=${a.id}`}))),c:e.f(I.value,((a,l,o)=>({a:e.t(a.name),b:e.f(JSON.parse(a.list),((l,o,s)=>({a:e.t(l),b:-1!==b.value.findIndex((e=>l===e))?1:"",c:o,d:e.o((e=>((e,a)=>{console.log("chooseFlavor",a);let l=-1,o=e.some((e=>(l=b.value.findIndex((a=>a==e)),-1!=l)));const s=b.value.findIndex((e=>e==a));console.log("ind",l),console.log("indexInChosed",s),-1!=s||o?-1==s&&o&&l>=0?(console.log("2、当前口味没选过，但当前行选过口味，替换掉当前行选过的口味"),b.value.splice(l,1),b.value.push(a)):(console.log("3、当前口味选过，进行反选操作，也就是直接删除"),b.value.splice(s,1)):(console.log("1、当前口味没选过，且当前行没选过口味"),b.value.push(a)),f.value.flavors=b.value.join(","),console.log("选好口味后，看看带口味字符串的，dialog中的菜品长什么样？ dialogDish",f.value)})(JSON.parse(a.list),l)),o)}))),c:a.name}))),d:e.o((a=>(async a=>{if(console.log("addToCart",a),!b.value||b.value.length<=0)return e.index.showToast({title:"请选择规格",icon:"none"}),!1;const l={dishId:a.id,dishFlavor:b.value.join(",")};await t.addToCartAPI(l),await C(),b.value=[],m.value=!1})(f.value))),e:e.o((e=>m.value=!1)),f:m.value,g:0===c.value.length},0===c.value.length?{}:{h:e.t(g.value),i:e.t(parseFloat((Math.round(100*h.value)/100).toFixed(2))),j:e.o((a=>(console.log("submitOrder"),void e.index.navigateTo({url:"/pages/submit/submit"})))),k:e.o((()=>v.value=!v.value))},{l:e.o((e=>(async()=>{await t.cleanCartAPI(),await C(),v.value=!1})())),m:e.f(c.value,((a,l,o)=>e.e({a:a.pic,b:e.t(a.name),c:e.t(a.amount),d:e.t(a.dishFlavor),e:a.number&&a.number>0},a.number&&a.number>0?{f:e.o((e=>j(a,"购物车")),l)}:{},{g:a.number&&a.number>0},a.number&&a.number>0?{h:e.t(a.number)}:{},{i:e.o((e=>A(a,"购物车")),l),j:l}))),n:e.o((e=>v.value=v.value)),o:v.value,p:e.o((e=>v.value=!v.value)),q:!n.value,r:e.o(P)})}}),u=e._export_sfc(n,[["__scopeId","data-v-61c0adbb"]]);wx.createPage(u);
